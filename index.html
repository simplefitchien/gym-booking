const SPREADSHEET_ID = '16VagP02y4m82ym2ADxp60_Bdgo5sd21Q_4Jm2NII2wY'; 


function doGet(e) {
  // 回傳課表資料
  const data = getCourses(); 
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  // 處理預約請求
  const params = JSON.parse(e.postData.contents);
  const result = handleBooking(params); // 呼叫你原本的預約邏輯
  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// function getCourses() {
//   const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
//   const sheet = ss.getSheetByName("課程清單");
//   const data = sheet.getDataRange().getValues();
//   const headers = data.shift().map(h => String(h).trim()); 
//   return data.filter(row => row[0] !== "").map(row => {
//     let obj = {};
//     headers.forEach((header, i) => { obj[header] = row[i]; });
//     return obj;
//   });
// }
// 修正：getCourses 必須回傳陣列
function getCourses() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("課程清單");
  const values = sheet.getDataRange().getValues();
  const headers = values.shift();
  return values.map(row => {
    let obj = {};
    headers.forEach((h, i) => obj[h] = row[i]);
    return obj;
  });
}
// 這段必須留在 .gs 檔案裡
function handleBooking(params) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000); 
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const courseSheet = ss.getSheetByName("課程清單");
    const recordSheet = ss.getSheetByName("預約紀錄");
    
    if (!recordSheet) return { "result": "失敗：找不到『預約紀錄』分頁" };

    const courseData = courseSheet.getDataRange().getValues();
    let targetRow = -1;
    let courseName = "";

    for (let i = 1; i < courseData.length; i++) {
      if (String(courseData[i][0]).trim() === String(params.courseId).trim()) {
        targetRow = i + 1;
        courseName = courseData[i][2];
        break;
      }
    }

    if (targetRow === -1) return { "result": "失敗：找不到課程" };

    // 寫入預約紀錄
    recordSheet.appendRow([params.courseId, courseName, params.userName, params.userId, new Date()]);
    
    // 更新人數 (第 8 欄為 H 欄)
    const countCell = courseSheet.getRange(targetRow, 8);
    countCell.setValue(Number(countCell.getValue()) + 1);

    return { "result": "預約成功！" };
  } catch (err) {
    return { "result": "系統失敗：" + err.toString() };
  } finally {
    lock.releaseLock();
  }
}